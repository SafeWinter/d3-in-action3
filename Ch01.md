# 1 An introduction to `D3.js`

# 第一章 `D3.js` 入门



### This chapter covers

- Understanding the role of D3.js and the philosophy behind it
- Recognizing the tools that are used in combination with D3 to create data visualizations
- Creating and styling Scalable Vector Graphics (SVG) with code
- Learning how data visualization best practices can support your journey as a D3 developer

本章要点

- 理解 `D3.js` 的定位及设计理念；
- 了解可与 `D3` 搭配使用的数据可视化工具；
- 用代码创建并设置 `SVG` 图形；
- 了解数据可视化最佳实践在 `D3` 开发过程中的支撑作用



D3.js is behind nearly all the most innovative and exciting information visualizations. D3, which stands for Data-Driven Documents, is a brand name but also a class of applications that have been offered on the web in one form or another for years. We can use this library to build an extended variety of data-driven projects, from simple bar charts to dynamic maps to intricate explorations of space and time. D3 is the tool of choice when you want to have total creative and technical freedom over your data visualizations, whether you build prototypes for research, extensive data dashboards at a top tech company, or innovative data scrollytelling pages for the web.

`D3.js` 支持几乎所有最具创造力的、令人振奋的信息可视化展示。`D3` 即数据驱动文档（**Data-Driven Documents**）的英文首字母缩写，它既是一个商标名，也是近年来网上以某种形式提供的一类应用程序。`D3` 可用于构建各种各样的数据驱动项目：从简单的条形图到动态地图、再到对空间和时间的复杂效果探索。无论是研究构建原型、打造顶级科技公司全覆盖的数据仪表盘，还是绘制富有创意的 `Web` 滚动讲述页面，当您希望在数据可视化上拥有完全的创意空间和技术自由时，`D3` 将是您的不二之选。



## 1.1 D3.js 是什么 What is D3.js

D3 is an open-source JavaScript library created in 2011 by Mike Bostock to generate dynamic and interactive data visualizations for the web. Although many new data visualization libraries have been introduced in the past few years, they often use D3 under the hood. This is because D3 is extremely flexible and powerful.

`D3` 是由美国设计师 *Mike Bostock* 于 2011 年创建的、用于生成动态的、交互式 `Web` 端数据可视化效果的开源 `JavaScript` 工具库。尽管过去这些年涌现了大量新的可视化工具库，其底层往往用到的都是 `D3`。这是因为 `D3` 非常灵活且功能强大。



![every line in Hamilton](assets/1-1.png)

**图 1.1 汉密尔顿每句台词的交互式可视化展示效果（由 *Shirley Wu* 创建的 `D3` [可视化](https://pudding.cool/2017/03/hamilton))**



### 1.1.1 Web 端访问数据可视化的需要 A need for web-accessible data visualizations

`D3.js` 的诞生是为了满足在 `Web` 端访问复杂的数据可视化的迫切需求。假如您的公司正在使用的商业智能工具无法提供团队需要的那种数据展示效果，这时就必须根据特定需求量身定制一个数据面板，来准确展示客户的行为模式。该面板要能快速响应、可供交互并且能在整个组织中共享数据。为此您需要选用 `D3`。

或者想象一下：您受雇实现一个网页效果，旨在反映全球范围内 `LGBTQ` 的群体权力在过去几十年和演变情况。此页面包含许多随着页面滚动而变换的创新性可视化效果，能通过鼠标事件显示更多的信息、并自动适应屏幕大小。`D3` 将是构建此类项目的首选工具。

*Mike Bostock* 创建 `D3` 的初衷，是为了利用新兴的 `Web` 标准，正如他所说：“避免专享的表现形式，并提供极致的灵活性，充分挖掘 `CSS3`、`HTML5` 和 `SVG` 等 `Web` 标准的最大潜力”（http://d3js.org)。 `D3.js` 第七版是目前这个热门工具库的最新版，通过模块化 `D3` 的各个组件，使其与 `ECMAScript` 模块和现代应用程序开发完全兼容，从而引领流行趋势。

`D3.js` 使开发者不仅能制作出具有丰富交互效果的应用程序，而且也能像传统 `Web` 应用程序那样提供样式和服务。这使得它们的可移植性更强，更适合不断扩展；对于大型团队中不了解 `D3` 特定语法的其他成员而言，也能通过设置 `CSS` 样式，很方便地进行项目维护。



![map representation with D3](assets/1-2.png)

**图1.2 D3 开发者能接触到各类数据呈现方式，例如地图。这是 [Christophe Viau](https://christopheviau.com/) 绘制的地图效果**



*Bostock* 决定对数据进行最泛化的处理并创建一个通用工具库，使其展示出的地图效果，能够像展示图表、展示网络或者展示列表那样容易。这也意味着，开发者无需为了展示地图去单独了解具体某个库的抽象层及语法、为了实现动态文本效果再学习另一个库的语法、或者仅仅为了绘制传统图形再去学习相应的某个库。相反，用于实现交互式网络可视化效果的代码接近于纯原生 `JavaScript`，也类似于在 `D3` 地图上动态描点的代码。不仅方法相同，数据也可以相同，只是以一种方式表示网络的节点与链接，而以另一种方式表示地图上的地理空间罢了。

`D3` 不仅可以创建复杂多样的图形，还可以嵌入用户期望的高级交互，这对现代 `Web` 开发至关重要。使用 `D3`，每个图表的每个元素，从旋转的地球仪到饼状图的一部分，都以相同的方式进行交互。由于 `D3` 是由精通数据可视化实践的专家创建的，因此它涵盖了数据可视化和 `Web` 开发中众多标准的交互式组件和行为。

![network visualization](assets/1-3.png)

**图1.3 页面交互是 D3 的核心。该 [网络可视化效果](https://amdufour.github.io/organizations-against-polarization) 的鼠标事件交互揭示了不同组织之间的关系，以及特定于所选节点的信息**



### 1.1.2 何时使用 `D3.js` When do we use D3.js?

数据可视化领域方兴未艾，可用于生成数据绑定图形的工具，其数量在过去十年中呈爆炸式增长。我们拥有商业智能工具，如数据可视化的入门级工具 `Excel`，以及微软用于构建数据仪表盘的 `Power BI`。数据科学家通常会求助于 `R` 语言的 `ggplot2` 库或 `Python` 的 `matplotlib` 库。我们都听说过 `Tableau`，利用它可以非常快速地生成数据可视化效果。数据分析师、科学家和统计学家可以使用 `Tableau` 正式地交流数据，而数据可视化设计师则可以使用它制作出令人惊叹的作品。我们现在还可以使用面向信息图表（`infographics`）的工具，例如 `Visme` 等，以快速生成像 `RawGraphs` 这样的特定图表。此外还有为新闻编辑室提供技术支撑的 `Datawrapper`。

如今，新一类专注于网络数据可视化的工具库层出不穷，像 `HighCharts`、`Google Charts`、`Flourish`、`C3.js`、`Chart.js` 等等，当然还有 `D3.js`，不一而足。

那么，`D3` 在这片数据可视化工具的海洋中处于什么位置呢？我们该何时以及如何使用它呢？可以这么说，尽管 `D3` 可以完全构建此处列出的数据可视化库提供的任何图表，但它通常不是构建传统意义上的简单图表或探索阶段的首选工具。我们在探索阶段考察的重点，是找出最适合我们展示意图的可视化效果。构建 `D3` 项目的确需要时间，但它却能在复杂、交互式和定制项目中真正大放异彩。数据可视化可不仅仅是绘制折线图和散点图！虽然上述工具通常专注于特定的图表，但 `D3` 允许我们将数据绑定到任何图形元素中，并以独特的方式组合这些视觉元素来打破常规。我们使用 `D3` 是因为想要跳出条条框框自由地思考，不受制与工具库所提供的现有功能。

![figure 1.4](assets/1-4.png)

**图 1.4 `D3` 拥有 `SVG` 和 `canvas` 的绘图函数，允许开发人员构建自定义可视化效果，例如 [Elijah Meeks](http://elijahmeeks.com/) 制作的乐谱演示效果。**

上例演示了如何在数据可视化项目范围内使用 `D3`。首先从预先存在的数据集或手动收集的数据开始。在开始数据分析之前，我们通常会花费大量时间清理、格式化和准备数据。 `Python` 和 `R` 语言等数据科学工具在这方面非常强大，可以帮助我们识别隐藏在数据中的（诸多）真相。`Excel` 也可以完成简单的数据整理和分析工作，并且对技术背景的要求也不高。 我们甚至可以使用 `JavaScript` 和 `D3` 进行基本的数据探索，因为它们提供了后续章节还会讲到的统计学的方法。

进行数据分析，通常会创建一些原型来帮助完善我们的展示内容。`Tableau` 和 `RawGraphs` 等工具使我们能够快速生成此类图表。这是一个非常重要的步骤，在这个阶段创建的可视化效果通常并不花哨或多么精致。我们不想在这个原型设计阶段花很多时间在我们的想法上。我们可能最终会发现，自己不得不“杀死我们的宝贝”并重复操作几次，直到确定最适合当前故事讲述的可视化效果。这当中网络图可能是个例外，直接选用 `D3` 通常对这些项目而言更有意义。

最后，一旦明确即将创建的可视化类型，就该卷起袖子进行编码，并使用 `D3` 进行改进。 如今，编码这步通常发生在使用 `React` 或 `Svelte` 等框架的单页面应用程序 (`SPA`) 。

![img](assets/1-5.png)

**图 1.5 使用 `D3` 构建自定义可视化效果的又一示例，其中形状与每首歌曲的不同属性（如持续时间、流派和节奏）成比例（[https://amdufour.github.io/spotify-hits](https ://amdufour.github.io/spotify-hits/)）**



### 1.1.3 `D3.js` 工作原理 How D3.js works

You might have already experimented with D3 and found that it isn’t easy to get into. Maybe that’s because you expected it to be a simple charting library. A case in point is creating a bar chart, which we’ll do in chapter 2. D3 doesn’t have one single function to create a bar chart. Instead, it has a function that appends a `<svg>` container into the Document Object Model (DOM) and another set of functions that appends one `<rect>` element for each data point. We then use scales to calculate the length of the rectangles that compose our histogram and set their attributes. Finally, we call another set of functions that adds an x and a y-axis to the bar chart. As you can see in figure 1.6, it’s a much longer process than using a dedicated charting library like Highcharts. But the explicit manner in which D3 deals with data and graphics is also its strength. Although other charting libraries conveniently allow you to make line graphs and pie charts, they quickly break down when you want to create a visualization that falls outside of the traditional charts spectrum or even when you want to apply your own twist to them. Not D3. D3 allows you to build whatever data-driven graphics and interactivity you can imagine.

![img](assets/1-6.png)

In figure 1.7, you see a map of how we generally approach the coding of a data visualization with D3. We start with a dataset, often a CSV or a JSON file, and we use the d3-fetch module to load this dataset into our project. We usually need to perform a few manipulations to format the data. For example, we ensure that our numbers and dates are correctly formatted. If we didn’t do it previously, we might also want to interrogate our dataset to find its main characteristics. For instance, knowing its maximum and minimum values in advance is often helpful. We are then ready to start building our visualization, for which we’ll combine the different D3 functions that we will learn in this book. Finally, we add interactivity by listening to mouse events, allowing users to filter the data or zoom in on the visualization.

![img](assets/1-7.png)



## 1.2 D3 生态——开始前需要明白的事 The D3 ecosystem - What you need to know to get started

